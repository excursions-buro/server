import bcrypt from 'bcryptjs';
import dotenv from 'dotenv';
import { PrismaClient } from '../src/generated/prisma';

dotenv.config();

const prisma = new PrismaClient();
const SALT_ROUNDS = parseInt(process.env.BCRYPT_SALT_ROUNDS!) || 10;

const images = [
  'https://images.unsplash.com/photo-1714842498650-53d45e04937d',
  'https://images.unsplash.com/photo-1520106212299-d99c443e4568',
  'https://images.unsplash.com/photo-1523509433743-6f42a58221df',
  'https://plus.unsplash.com/premium_photo-1697729938237-680e72596e15',
  'https://images.unsplash.com/photo-1531168738274-aa9955d5033f',
];

async function main() {
  console.log('üßπ –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
  await prisma.$transaction([
    prisma.orderItem.deleteMany(),
    prisma.order.deleteMany(),
    prisma.scheduleSlot.deleteMany(),
    prisma.schedule.deleteMany(),
    prisma.ticketCategory.deleteMany(),
    prisma.excursionImage.deleteMany(),
    prisma.excursion.deleteMany(),
    prisma.excursionType.deleteMany(),
    prisma.discount.deleteMany(),
    prisma.user.deleteMany(),
  ]);

  console.log('üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ —ç–∫—Å–∫—É—Ä—Å–∏–π...');
  await prisma.excursionType.createMany({
    data: [
      { name: '–ü–µ—à–µ—Ö–æ–¥–Ω–∞—è' },
      { name: '–í–æ–¥–Ω–∞—è' },
      { name: '–ê–≤—Ç–æ–±—É—Å–Ω–∞—è' },
      { name: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è' },
    ],
  });

  const types = await prisma.excursionType.findMany({
    orderBy: { name: 'asc' },
  });
  const [walking, water, bus, individual] = types;

  console.log('üñº –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Å–∫—É—Ä—Å–∏–π —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏...');
  const excursions = await Promise.all([
    prisma.excursion.create({
      data: {
        title: '–ú–æ—Å–∫–≤–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è',
        description: '–û–±–∑–æ—Ä–Ω–∞—è —ç–∫—Å–∫—É—Ä—Å–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É –ú–æ—Å–∫–≤—ã',
        typeId: walking.id,
        basePrice: 1000,
        currency: 'RUB',
        mainImage: images[0],
        images: {
          create: [{ url: images[1] }, { url: images[2] }],
        },
      },
    }),
    prisma.excursion.create({
      data: {
        title: '–í–¥–æ–ª—å –ø–æ –ú–æ—Å–∫–≤–∞-—Ä–µ–∫–µ',
        description: '–ü—Ä–æ–≥—É–ª–∫–∞ –Ω–∞ —Ç–µ–ø–ª–æ—Ö–æ–¥–µ –ø–æ –ú–æ—Å–∫–≤–µ-—Ä–µ–∫–µ',
        typeId: water.id,
        basePrice: 1500,
        currency: 'RUB',
        mainImage: images[3],
        images: {
          create: [{ url: images[4] }, { url: images[0] }],
        },
      },
    }),
    prisma.excursion.create({
      data: {
        title: '–ê–≤—Ç–æ–±—É—Å–Ω—ã–π —Ç—É—Ä –ø–æ –ú–æ—Å–∫–≤–µ',
        description:
          '–ö–æ–º—Ñ–æ—Ä—Ç–∞–±–µ–ª—å–Ω—ã–π –∞–≤—Ç–æ–±—É—Å–Ω—ã–π —Ç—É—Ä –ø–æ –≥–ª–∞–≤–Ω—ã–º –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º',
        typeId: bus.id,
        basePrice: 2000,
        currency: 'RUB',
        mainImage: images[1],
        images: {
          create: [{ url: images[2] }, { url: images[3] }],
        },
      },
    }),
  ]);

  console.log('üéü –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –±–∏–ª–µ—Ç–æ–≤...');
  const ticketCategories = [];
  for (const excursion of excursions) {
    let categories;
    if (excursion.title.includes('–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è')) {
      categories = [
        { name: '–í–∑—Ä–æ—Å–ª—ã–π', price: 1000 },
        { name: '–î–µ—Ç–∏ –¥–æ 14', price: 600 },
        { name: '–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä—ã', price: 700 },
      ];
    } else if (excursion.title.includes('–ú–æ—Å–∫–≤–∞-—Ä–µ–∫–µ')) {
      categories = [
        { name: '–í–∑—Ä–æ—Å–ª—ã–π', price: 1500 },
        { name: '–°—Ç—É–¥–µ–Ω—Ç—ã', price: 900 },
        { name: '–ì—Ä—É–ø–ø—ã –æ—Ç 10 —á–µ–ª.', price: 1200 },
      ];
    } else {
      categories = [
        { name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', price: 2000 },
        { name: '–õ—å–≥–æ—Ç–Ω—ã–π', price: 1500 },
        { name: 'VIP', price: 3500 },
      ];
    }

    for (const category of categories) {
      const created = await prisma.ticketCategory.create({
        data: {
          ...category,
          excursionId: excursion.id,
        },
      });
      ticketCategories.push(created);
    }
  }

  console.log('üìÜ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π...');
  const schedules = [];
  for (const excursion of excursions) {
    let scheduleData;
    if (excursion.title.includes('–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è')) {
      scheduleData = {
        startDate: new Date('2025-05-20'),
        endDate: new Date('2025-06-20'),
      };
    } else if (excursion.title.includes('–ú–æ—Å–∫–≤–∞-—Ä–µ–∫–µ')) {
      scheduleData = {
        startDate: new Date('2025-06-01'),
        endDate: new Date('2025-07-01'),
      };
    } else {
      scheduleData = {
        startDate: new Date('2025-07-01'),
        endDate: new Date('2025-08-01'),
      };
    }

    const schedule = await prisma.schedule.create({
      data: {
        ...scheduleData,
        excursionId: excursion.id,
        status: 'ACTIVE',
      },
    });
    schedules.push(schedule);
  }

  console.log('üïí –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤...');
  const slots = [];
  for (const schedule of schedules) {
    let slotData;
    if (schedule.startDate.getMonth() === 4) {
      // –ú–∞–π
      slotData = [
        { weekDay: 2, time: '14:00', maxPeople: 20 },
        { weekDay: 3, time: '15:00', maxPeople: 15 },
        { weekDay: 5, time: '11:00', maxPeople: 25 },
      ];
    } else if (schedule.startDate.getMonth() === 5) {
      // –ò—é–Ω—å
      slotData = [
        { weekDay: 4, time: '12:00', maxPeople: 30 },
        { weekDay: 5, time: '18:00', maxPeople: 15 },
        { weekDay: 6, time: '16:00', maxPeople: 20 },
      ];
    } else {
      // –ò—é–ª—å
      slotData = [
        { weekDay: 1, time: '10:00', maxPeople: 40 },
        { weekDay: 3, time: '14:00', maxPeople: 40 },
        { weekDay: 6, time: '12:00', maxPeople: 35 },
      ];
    }

    for (const slot of slotData) {
      const created = await prisma.scheduleSlot.create({
        data: {
          ...slot,
          scheduleId: schedule.id,
        },
      });
      slots.push(created);
    }
  }

  console.log('üë• –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
  const users = await Promise.all([
    prisma.user.create({
      data: {
        email: 'admin@mskburo.ru',
        password: await bcrypt.hash('SecureAdmin123!', SALT_ROUNDS),
        name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        role: 'ADMIN',
        refreshTokens: [],
      },
    }),
    prisma.user.create({
      data: {
        email: 'user1@example.com',
        password: await bcrypt.hash('UserPass123!', SALT_ROUNDS),
        name: '–ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞',
        role: 'USER',
        refreshTokens: [],
      },
    }),
    prisma.user.create({
      data: {
        email: 'guide1@mskburo.ru',
        password: await bcrypt.hash('GuidePass123!', SALT_ROUNDS),
        name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
        role: 'GUIDE',
        refreshTokens: [],
      },
    }),
  ]);

  console.log('üè∑ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫...');
  const discounts = await prisma.discount.createMany({
    data: [
      {
        code: 'SUMMER2025',
        value: 15,
        isPercent: true,
        validFrom: new Date('2025-06-01'),
        validTo: new Date('2025-09-01'),
        maxUses: 100,
        minOrderAmount: 2000,
      },
      {
        code: 'EARLYBIRD',
        value: 500,
        isPercent: false,
        validFrom: new Date(),
        validTo: new Date('2025-12-31'),
        maxUses: 50,
        minOrderAmount: 3000,
      },
      {
        code: 'WELCOME10',
        value: 10,
        isPercent: true,
        validFrom: new Date(),
        validTo: new Date('2026-01-01'),
        maxUses: null, // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
      },
    ],
  });

  const summerDiscount = await prisma.discount.findFirst({
    where: { code: 'SUMMER2025' },
  });

  console.log('üßæ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤...');
  // –ó–∞–∫–∞–∑ –±–µ–∑ —Å–∫–∏–¥–∫–∏ (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
  await prisma.order.create({
    data: {
      userId: users[1].id,
      contactName: '–ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞',
      contactEmail: 'user1@example.com',
      contactPhone: '+79991234567',
      totalPrice: 2600,
      items: {
        create: [
          {
            ticketCategoryId: ticketCategories[0].id,
            quantity: 2,
            price: 1000,
            scheduleSlotId: slots[0].id,
          },
          {
            ticketCategoryId: ticketCategories[3].id,
            quantity: 1,
            price: 1500,
            scheduleSlotId: slots[3].id,
          },
        ],
      },
    },
  });

  // –ó–∞–∫–∞–∑ —Å–æ —Å–∫–∏–¥–∫–æ–π (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
  await prisma.order.create({
    data: {
      userId: users[1].id,
      contactName: '–ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞',
      contactEmail: 'user1@example.com',
      contactPhone: '+79991234567',
      totalPrice: 4800,
      discountId: summerDiscount?.id,
      discountAmount: 720, // 15% –æ—Ç 4800
      status: 'PAID',
      items: {
        create: [
          {
            ticketCategoryId: ticketCategories[5].id,
            quantity: 3,
            price: 1600,
            scheduleSlotId: slots[5].id,
          },
        ],
      },
    },
  });

  // –ó–∞–∫–∞–∑ —Å VIP –±–∏–ª–µ—Ç–∞–º–∏ (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
  await prisma.order.create({
    data: {
      userId: users[0].id,
      contactName: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
      contactEmail: 'admin@mskburo.ru',
      contactPhone: '+79998887766',
      totalPrice: 10500,
      status: 'PAID',
      emailSent: true,
      items: {
        create: [
          {
            ticketCategoryId: ticketCategories[8].id, // VIP
            quantity: 3,
            price: 3500,
            scheduleSlotId: slots[7].id,
          },
        ],
      },
    },
  });

  // –ì–æ—Å—Ç–µ–≤–æ–π –∑–∞–∫–∞–∑ (–±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
  await prisma.order.create({
    data: {
      contactName: '–ü–µ—Ç—Ä –°–∏–¥–æ—Ä–æ–≤',
      contactEmail: 'guest@example.com',
      contactPhone: '+79995554433',
      totalPrice: 3000,
      status: 'PENDING',
      items: {
        create: [
          {
            ticketCategoryId: ticketCategories[1].id,
            quantity: 2,
            price: 600,
            scheduleSlotId: slots[2].id,
          },
          {
            ticketCategoryId: ticketCategories[2].id,
            quantity: 1,
            price: 700,
            scheduleSlotId: slots[2].id,
          },
        ],
      },
    },
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π —Å–∫–∏–¥–∫–∏
  if (summerDiscount) {
    await prisma.discount.update({
      where: { id: summerDiscount.id },
      data: { usedCount: 1 },
    });
  }

  console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!');
  console.log('üîë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:', users[0].email);
  console.log('üë§ –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', users[1].email);
  console.log('üö© –ì–∏–¥:', users[2].email);
  console.log('üé´ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫—Å–∫—É—Ä—Å–∏–π:', excursions.length);
  console.log('‚è± –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤:', slots.length);
  console.log('üí≥ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤:', 4); // –û–±–Ω–æ–≤–∏–ª–∏ —Å—á–µ—Ç—á–∏–∫ –∑–∞–∫–∞–∑–æ–≤
  console.log('üè∑ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–∏–¥–æ–∫:', 3);
}

main()
  .catch((e) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ë–î:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
